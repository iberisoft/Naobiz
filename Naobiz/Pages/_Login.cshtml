@page

@namespace Naobiz.Pages
@using System.Security.Claims;
@using Microsoft.AspNetCore.Authentication;
@using Naobiz.Data

@inject AppDbContext DbContext

@functions {
    public async Task<IActionResult> OnGetAsync(string email, string password)
    {
        var user = DbContext.Users.SingleOrDefault(user => user.Email == email && user.ActivationCode == null && user.Password == password);
        if (user != null)
        {
            var ipAddress = HttpContext.Connection.RemoteIpAddress;
            ipAddress = ipAddress.MapToIPv4();
            user.UpdateLoginInfo(ipAddress);
            await DbContext.SaveChangesAsync();

            var claim = new Claim(ClaimsIdentity.DefaultNameClaimType, email);
            var id = new ClaimsIdentity(new[] { claim }, "ApplicationCookie", ClaimsIdentity.DefaultNameClaimType, ClaimsIdentity.DefaultRoleClaimType);
            await HttpContext.SignInAsync(new ClaimsPrincipal(id));
        }

        return LocalRedirect("/");
    }
}
