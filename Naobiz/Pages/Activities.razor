@page "/activities"

@inherits AuthorizedBase
@inject NavigationManager NavigationManager
@inject UserService UserService

<Heading Size="HeadingSize.Is1">Activities</Heading>

@if (models == null)
{
    <Paragraph>Loading...</Paragraph>
    return;
}

<Row>
    <Column>
        @foreach (var model in models.Take(models.Count / 2))
        {
            <Field>
                <CheckEdit @bind-Checked="model.Selected">@model.Value.Name</CheckEdit>
            </Field>
        }
    </Column>
    <Column>
        @foreach (var model in models.Skip(models.Count / 2))
        {
            <Field>
                <CheckEdit @bind-Checked="model.Selected">@model.Value.Name</CheckEdit>
            </Field>
        }
    </Column>
</Row>
<Row>
    <Column>
        <Button Color="Color.Primary" Clicked="SubmitChanges">Submit</Button>
    </Column>
</Row>

@code {
    User user;
    List<SelectedValue<Activity>> models;
    List<Activity> selectedActivities;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        user = await UserService.GetCurrentAsync(Service);
        if (user == null)
        {
            return;
        }

        selectedActivities = await Service.GetActivities(user).ToListAsync();
        models = SelectedValue<Activity>.Create(await Service.Activities.ToListAsync(), selectedActivities).ToList();
    }

    private async Task SubmitChanges()
    {
        foreach (var model in models)
        {
            if (model.Selected)
            {
                if (!selectedActivities.Contains(model.Value))
                {
                    Service.AddActivity(user, model.Value);
                }
            }
            else
            {
                if (selectedActivities.Contains(model.Value))
                {
                    await Service.RemovevActivityAsync(user, model.Value);
                }
            }
        }
        await Service.SaveChangesAsync();

        NavigationManager.NavigateTo("");
    }
}
